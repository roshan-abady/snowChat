create or replace view ES_ERP_LICENSE_MOVEMENT_DASHBOARD(
	MONTH_ID,
	CONTRACT_ID,
	REPORTING_OPEN_DATE,
	PROD_EDITION,
	PROD_ITEM_EDITION,
	INVENTORY_ID,
	OPENING_CONTRACT_SCHEDULE_LINE_NUMBER,
	OPENING_SCHEDULE_GENERATED_DATE,
	CLOSING_CONTRACT_SCHEDULE_LINE_NUMBER,
	CLOSING_SCHEDULE_GENERATED_DATE,
	USER_TYPE,
	USER_TYPE_DESCRIPTION,
	CONTRACT_BEGINNING_DATE,
	CANCELLED_ON_DATE,
	CANCEL_REASON,
	CONTRACT_REVISION_NUMBER,
	MAX_CONTRACT_SCHEDULE_LINE_NUMBER,
	CONTRACT_STATUS,
	CONTRACT_STATUS_CALC,
	CONTRACT_CLASS,
	BRANCH_ID,
	END_CUSTOMER_NAME,
	AR_CUSTOMER,
	AR_ACCOUNT_NAME,
	CONTRACT_DESCRIPTION,
	PARTNER_PROJECT,
	PROJECT_DESCRIPTION,
	ACCOUNT_ARCHIE_ID,
	LICENSE_STATUS,
	CURRENCY,
	OPPORTUNITY_SOURCE,
	CONTRACT_DATE,
	ACCOUNT_LOCATION_ID,
	PAYMENT_METHOD_ID,
	PRICE_CLASS_ID,
	PARTNER_NAME,
	PARTNER,
	ORDER_SOURCE,
	SCHEDULE_GENERATED_DATE,
	AUTO_GENERATION_ID,
	QUOTE_NUMBER,
	AR_REF_NUMBER,
	POSTING_CLASS,
	CLASS_ID,
	EDITION_PRODUCT,
	ITEM_EDITION_DESCRIPTION,
	EDITION_USER_DESCRIPTION,
	EDITION_ID,
	EDITION_CODE,
	PRODUCT_CLASS,
	PRODUCT_DESCRIPTION,
	INDUSTRY,
	SUB_INDUSTRY,
	CONTRACT_AGE_YEARS,
	CONTRACT_AGE_MONTHS,
	BRANCH_CD,
	CONTRACT_CD,
	CUSTOMER_ID,
	ACCOUNT_STATUS,
	CUSTOMER_CLASS,
	AR_ACCOUNT_STATUS,
	OPENING_QUANTITY,
	CLOSING_QUANTITY,
	QUANTITY_CHANGE,
	QUANTITY_STATUS,
	UOM,
	BANDED_UNIT_PRICE_FLAG,
	OPENING_BASE_QUANTITY,
	CLOSING_BASE_QUANTITY,
	BASE_QUANTITY_CHANGE,
	BASE_QUANTITY_STATUS,
	OPENING_AVERAGE_UNIT_PRICE,
	CLOSING_AVERAGE_UNIT_PRICE,
	AVERAGE_UNIT_PRICE_CHANGE,
	AVERAGE_UNIT_PRICE_STATUS,
	OPENING_AVERAGE_BANDED_UNIT_PRICE,
	CLOSING_AVERAGE_BANDED_UNIT_PRICE,
	AVERAGE_BANDED_UNIT_PRICE_CHANGE,
	AVERAGE_BANDED_UNIT_PRICE_STATUS,
	OPENING_DISCOUNT_AMOUNT,
	CLOSING_DISCOUNT_AMOUNT,
	DISCOUNT_AMOUNT_CHANGE,
	DISCOUNT_CHANGE_STATUS,
	OPENING_ARR,
	CLOSING_ARR,
	ARR_CHANGE,
	ARR_CHANGE_STATUS,
	COUNT_USER_TYPE_LINES,
	MOVEMENT_TYPE,
	ARR_CHANGE_FOR_WATERFALL,
	CLOSING_FINAL_ARR,
	SEGMENT
) as 


(SELECT 
MONTH_ID, 
CONTRACT_ID, 
REPORTING_OPEN_DATE, 
PROD_EDITION, 
PROD_ITEM_EDITION, 
INVENTORY_ID, 
OPENING_CONTRACT_SCHEDULE_LINE_NUMBER, 
OPENING_SCHEDULE_GENERATED_DATE, 
CLOSING_CONTRACT_SCHEDULE_LINE_NUMBER, 
CLOSING_SCHEDULE_GENERATED_DATE, 
USER_TYPE, 
USER_TYPE_DESCRIPTION, 
CONTRACT_BEGINNING_DATE, 
CANCELLED_ON_DATE, 
CANCEL_REASON, 
CONTRACT_REVISION_NUMBER, 
MAX_CONTRACT_SCHEDULE_LINE_NUMBER, 
CONTRACT_STATUS, 
CONTRACT_STATUS_CALC, 
CONTRACT_CLASS, 
BRANCH_ID, 
END_CUSTOMER_NAME, 
AR_CUSTOMER, 
AR_ACCOUNT_NAME, 
CONTRACT_DESCRIPTION, 
PARTNER_PROJECT, 
PROJECT_DESCRIPTION, 
ACCOUNT_ARCHIE_ID, 
LICENSE_STATUS, 
CURRENCY, 
OPPORTUNITY_SOURCE, 
CONTRACT_DATE, 
ACCOUNT_LOCATION_ID, 
PAYMENT_METHOD_ID, 
PRICE_CLASS_ID, 
PARTNER_NAME, 
PARTNER, 
CASE WHEN PARTNER_NAME LIKE '%MYOB%' THEN 'DIRECT' ELSE 'PARTNER' END AS ORDER_SOURCE,
SCHEDULE_GENERATED_DATE, 
AUTO_GENERATION_ID, 
QUOTE_NUMBER, 
AR_REF_NUMBER, 
POSTING_CLASS, 
CLASS_ID, 
EDITION_PRODUCT, 
ITEM_EDITION_DESCRIPTION, 
EDITION_USER_DESCRIPTION, 
EDITION_ID, 
EDITION_CODE, 
PRODUCT_CLASS, 
PRODUCT_DESCRIPTION, 
INDUSTRY, 
SUB_INDUSTRY, 
CONTRACT_AGE_YEARS, 
CONTRACT_AGE_MONTHS, 
BRANCH_CD, 
CONTRACT_CD, 
CUSTOMER_ID, 
ACCOUNT_STATUS, 
CUSTOMER_CLASS, 
AR_ACCOUNT_STATUS, 
OPENING_QUANTITY, 
CLOSING_QUANTITY, 
QUANTITY_CHANGE, 
QUANTITY_STATUS, 
UOM, 
BANDED_UNIT_PRICE_FLAG, 
OPENING_BASE_QUANTITY, 
CLOSING_BASE_QUANTITY, 
BASE_QUANTITY_CHANGE, 
BASE_QUANTITY_STATUS, 
OPENING_AVERAGE_UNIT_PRICE, 
CLOSING_AVERAGE_UNIT_PRICE, 
AVERAGE_UNIT_PRICE_CHANGE, 
AVERAGE_UNIT_PRICE_STATUS, 
OPENING_AVERAGE_BANDED_UNIT_PRICE, 
CLOSING_AVERAGE_BANDED_UNIT_PRICE, 
AVERAGE_BANDED_UNIT_PRICE_CHANGE, 
AVERAGE_BANDED_UNIT_PRICE_STATUS, 
OPENING_DISCOUNT_AMOUNT, 
CLOSING_DISCOUNT_AMOUNT, 
DISCOUNT_AMOUNT_CHANGE, 
DISCOUNT_CHANGE_STATUS, 
OPENING_ARR, 
CLOSING_ARR, 
ARR_CHANGE, 
ARR_CHANGE_STATUS, 
COUNT_USER_TYPE_LINES, 
MOVEMENT_TYPE, 
ARR_CHANGE_FOR_WATERFALL,
SUM(CLOSING_ARR) OVER(PARTITION BY AR_CUSTOMER, MONTH_ID) AS CLOSING_FINAL_ARR,
CASE WHEN CLOSING_FINAL_ARR >= 100000 THEN 'MORE THAN 100K'
WHEN CLOSING_FINAL_ARR >= 70000 AND CLOSING_FINAL_ARR < 100000 THEN '70K-100K'
WHEN CLOSING_FINAL_ARR >= 50000 AND CLOSING_FINAL_ARR < 70000 THEN '50K-70K'
WHEN CLOSING_FINAL_ARR >= 30000 AND CLOSING_FINAL_ARR < 50000 THEN '30K-50K'
WHEN CLOSING_FINAL_ARR >= 20000 AND CLOSING_FINAL_ARR < 30000 THEN '20K-30K'
WHEN CLOSING_FINAL_ARR < 20000 THEN '<20K' END AS SEGMENT
FROM
OPERATIONS_ANALYTICS.TRANSFORMED_PROD.ES_ERP_CONTRACT_LINE_ITEMS_BY_USER_TYPE_BY_MONTH);